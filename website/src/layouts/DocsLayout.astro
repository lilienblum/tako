---
import BaseLayout from "./BaseLayout.astro";

export interface Props {
  title: string;
  heading: string;
  current?: string;
  headingAnchors?: boolean;
}

const { title, heading, current = "intro", headingAnchors = true } = Astro.props;

const docsNav = [
  { id: "intro", label: "The Why", href: "/docs" },
  { id: "quickstart", label: "Quickstart", href: "/docs/quickstart" },
  { id: "install", label: "Install", href: "/docs/install" },
  { id: "cli", label: "CLI Reference", href: "/docs/cli" },
  { id: "tako-toml", label: "tako.toml", href: "/docs/tako-toml" },
  { id: "development", label: "Development", href: "/docs/development" },
  { id: "deployment", label: "Deployment", href: "/docs/deployment" },
  { id: "operations", label: "Operations", href: "/docs/operations" },
  { id: "architecture", label: "How Tako Works", href: "/docs/architecture" },
];
---
<BaseLayout title={title} description="Tako documentation - a minimal deployment tool for self-hosted infrastructure.">
  <section class="sheet" data-docs-sheet data-heading-anchors={headingAnchors ? "true" : "false"}>
    <div class="sheet-top">
      <div class="breadcrumb">
        <a href="/">~</a> / <a href="/docs">docs</a> / <span>{heading}</span>
      </div>
      <button
        type="button"
        class="docs-menu-toggle"
        data-docs-menu-toggle
        aria-expanded="false"
        aria-controls="docs-nav-sidebar"
      >
        <span class="docs-menu-icon" aria-hidden="true"></span>
        <span>Menu</span>
      </button>
    </div>

    <div class="docs-shell">
      <aside class="docs-nav-sidebar" id="docs-nav-sidebar" data-docs-sidebar>
        <nav class="docs-nav-links" aria-label="Documentation navigation">
          {
            docsNav.map((item) => (
              <a href={item.href} class:list={["docs-nav-link", current === item.id && "is-active"]}>
                {item.label}
              </a>
            ))
          }
        </nav>
      </aside>

      <article class="docs-main">
        <div class="content">
          <slot />
        </div>
      </article>
    </div>
  </section>

  <script is:inline>
    const docsSheet = document.querySelector("[data-docs-sheet]");
    const toggle = docsSheet?.querySelector("[data-docs-menu-toggle]");
    const sidebar = docsSheet?.querySelector("[data-docs-sidebar]");
    const links = docsSheet ? Array.from(docsSheet.querySelectorAll(".docs-nav-link")) : [];
    const contentRoot = docsSheet?.querySelector(".content");

    if (toggle instanceof HTMLButtonElement && sidebar instanceof HTMLElement) {
      const setOpen = (open) => {
        toggle.setAttribute("aria-expanded", open ? "true" : "false");
        sidebar.classList.toggle("is-open", open);
      };

      setOpen(false);

      toggle.addEventListener("click", () => {
        const currentlyOpen = toggle.getAttribute("aria-expanded") === "true";
        setOpen(!currentlyOpen);
      });

      for (const link of links) {
        link.addEventListener("click", () => {
          if (window.matchMedia("(max-width: 900px)").matches) {
            setOpen(false);
          }
        });
      }

      window.addEventListener("resize", () => {
        if (window.innerWidth > 900) {
          setOpen(false);
        }
      });
    }

    if (contentRoot instanceof HTMLElement && docsSheet?.getAttribute("data-heading-anchors") === "true") {
      const headings = Array.from(
        contentRoot.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"),
      );

      for (const heading of headings) {
        if (!(heading instanceof HTMLElement)) {
          continue;
        }
        if (heading.querySelector(".docs-heading-anchor")) {
          continue;
        }

        const id = heading.getAttribute("id");
        if (!id) {
          continue;
        }

        const anchor = document.createElement("a");
        anchor.className = "docs-heading-anchor";
        anchor.href = `#${id}`;
        anchor.textContent = "#";

        const headingText = heading.textContent?.trim();
        anchor.setAttribute("aria-label", headingText ? `Link to section: ${headingText}` : `Link to section: ${id}`);
        anchor.title = "Link to this section";

        heading.append(anchor);

        heading.classList.add("docs-clickable-heading");
        heading.addEventListener("click", (event) => {
          if (!(event.target instanceof Element)) {
            return;
          }
          if (event.target.closest("a")) {
            return;
          }
          if (window.getSelection()?.toString()) {
            return;
          }
          window.location.hash = id;
        });
      }
    }
  </script>
</BaseLayout>

<style is:global>
  .paint::before,
  .paint::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    filter: blur(18px);
    animation: floatBlob 10s ease-in-out infinite;
  }

  .paint::before {
    width: 340px;
    height: 340px;
    top: -120px;
    left: -130px;
    background: rgba(232, 135, 131, 0.32);
  }

  .paint::after {
    width: 420px;
    height: 420px;
    bottom: -170px;
    right: -160px;
    background: rgba(155, 196, 182, 0.3);
    animation-delay: -4s;
  }

  .site {
    z-index: 2;
  }

  .sheet {
    border: 2px solid var(--line);
    border-radius: var(--panel-radius);
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 18px 45px rgba(47, 42, 68, 0.1);
    padding: clamp(18px, 4vw, 36px);
  }

  .sheet-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  .breadcrumb {
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 0;
  }

  .breadcrumb a {
    color: var(--muted);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    color: var(--accent);
  }

  .breadcrumb span {
    color: var(--accent);
  }

  .docs-shell {
    display: grid;
    grid-template-columns: minmax(220px, 250px) minmax(0, 1fr);
    gap: clamp(16px, 2.5vw, 28px);
    align-items: start;
  }

  .docs-nav-sidebar {
    border: 2px solid var(--line);
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.9);
    padding: 12px;
    position: sticky;
    top: 92px;
  }

  .docs-nav-links {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .docs-nav-link {
    text-decoration: none;
    color: var(--muted);
    border: 1px solid transparent;
    border-radius: 10px;
    padding: 7px 10px;
    font-size: 15px;
    line-height: 1.3;
  }

  .docs-nav-link:hover {
    color: var(--ink);
    background: rgba(155, 196, 182, 0.18);
    border-color: rgba(155, 196, 182, 0.4);
  }

  .docs-nav-link.is-active {
    color: var(--ink);
    background: rgba(232, 135, 131, 0.2);
    border-color: rgba(232, 135, 131, 0.45);
    font-weight: 700;
  }

  .docs-main {
    min-width: 0;
  }

  .content {
    line-height: 1.55;
    font-size: clamp(16px, 1.5vw, 19px);
    color: var(--muted);
  }

  .content h1,
  .content h2,
  .content h3,
  .content h4 {
    font-family: var(--font-heading);
    color: var(--ink);
    margin-top: 28px;
    margin-bottom: 12px;
    line-height: 1.2;
  }

  .content h1 {
    font-size: clamp(28px, 4.2vw, 36px);
    border-bottom: 2px solid var(--line);
    padding-bottom: 8px;
  }

  .content h2 {
    font-size: clamp(24px, 3.6vw, 30px);
  }

  .content h3 {
    font-size: clamp(20px, 3vw, 24px);
  }

  .content :is(h1, h2, h3, h4, h5, h6)[id] {
    scroll-margin-top: 108px;
    cursor: pointer;
  }

  .content .docs-clickable-heading {
    cursor: pointer;
  }

  .content .docs-clickable-heading:hover {
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 0.16em;
    text-decoration-color: rgba(232, 135, 131, 0.65);
  }

  .content .docs-heading-anchor {
    display: inline-block;
    margin-left: 8px;
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.75em;
    line-height: 1;
    color: var(--primary);
    border-bottom: none;
    text-decoration: none;
    opacity: 0;
    cursor: pointer;
    transition: opacity 0.14s ease;
  }

  .content :is(h1, h2, h3, h4, h5, h6)[id]:hover .docs-heading-anchor {
    opacity: 1;
  }

  .content p,
  .content ul,
  .content ol,
  .content table,
  .content blockquote,
  .content pre {
    margin: 14px 0;
  }

  .content ul,
  .content ol {
    padding-left: 24px;
  }

  .content li {
    margin: 7px 0;
  }

  .content a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 2px solid transparent;
  }

  .content a:hover {
    border-bottom-color: var(--accent);
  }

  .content code {
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.85em;
    padding: 2px 6px;
    border-radius: 8px;
    background: rgba(232, 135, 131, 0.12);
    color: #3f3557;
  }

  .content pre {
    padding: 18px 20px;
    border: 2px solid var(--line);
    border-radius: 16px;
    background: var(--paper);
    overflow-x: auto;
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    line-height: 1.5;
    color: #2b2640;
  }

  .content pre code {
    padding: 0;
    background: none;
  }

  .content blockquote {
    border-left: 4px solid var(--secondary);
    background: var(--mint-soft);
    border-radius: 0 12px 12px 0;
    padding: 12px 14px;
    color: #2c2b3d;
  }

  .content table {
    width: 100%;
    border-collapse: collapse;
    font-size: 15px;
    border: 2px solid var(--line);
  }

  .content th,
  .content td {
    border: 1px solid var(--line);
    padding: 8px 10px;
  }

  .content th {
    font-family: "Nunito", sans-serif;
    color: #2f2a44;
    background: rgba(155, 196, 182, 0.18);
  }

  .content hr {
    border: none;
    border-top: 2px solid var(--line);
    margin: 26px 0;
  }

  .content strong {
    color: #2f2a44;
  }

  .content .dynamic-phrase {
    font-weight: 600;
    color: var(--primary);
  }

  .docs-menu-icon,
  .docs-menu-icon::before,
  .docs-menu-icon::after {
    content: "";
    display: block;
    width: 16px;
    height: 2px;
    border-radius: 2px;
    background: var(--ink);
    transition: transform 0.16s ease;
  }

  .docs-menu-icon {
    position: relative;
  }

  .docs-menu-icon::before {
    position: absolute;
    top: -5px;
    left: 0;
  }

  .docs-menu-icon::after {
    position: absolute;
    top: 5px;
    left: 0;
  }

  .docs-menu-toggle[aria-expanded="true"] .docs-menu-icon {
    background: transparent;
  }

  .docs-menu-toggle[aria-expanded="true"] .docs-menu-icon::before {
    transform: translateY(5px) rotate(45deg);
  }

  .docs-menu-toggle[aria-expanded="true"] .docs-menu-icon::after {
    transform: translateY(-5px) rotate(-45deg);
  }

  @keyframes floatBlob {
    0%,
    100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .docs-menu-toggle {
    display: none;
    align-items: center;
    gap: 8px;
    font: inherit;
    font-size: 15px;
    font-weight: 700;
    border: 2px solid var(--line);
    border-radius: 999px;
    padding: 7px 12px;
    background: rgba(255, 255, 255, 0.92);
    color: var(--ink);
    cursor: pointer;
  }

  @media (max-width: 900px) {
    .sheet-top {
      margin-bottom: 14px;
    }

    .docs-menu-toggle {
      display: inline-flex;
    }

    .docs-shell {
      display: block;
    }

    .docs-nav-sidebar {
      position: static;
      display: none;
      margin-bottom: 14px;
    }

    .docs-nav-sidebar.is-open {
      display: block;
    }
  }

  @media (max-width: 640px) {
    .content pre {
      padding: 14px 16px;
    }
  }
</style>
