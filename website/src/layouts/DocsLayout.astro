---
import BaseLayout from "./BaseLayout.astro";
import SnippetCopyButton from "../components/SnippetCopyButton.astro";

export interface Props {
  title: string;
  heading: string;
  current?: string;
  headingAnchors?: boolean;
  frontmatter?: {
    title?: string;
    heading?: string;
    current?: string;
    headingAnchors?: boolean;
  };
}

const frontmatter = Astro.props.frontmatter ?? {};
const title = Astro.props.title ?? frontmatter.title ?? "Tako Docs";
const heading = Astro.props.heading ?? frontmatter.heading ?? "Docs";
const current = Astro.props.current ?? frontmatter.current ?? "intro";
const headingAnchors = Astro.props.headingAnchors ?? frontmatter.headingAnchors ?? true;

const docsNav = [
  { id: "intro", label: "Intro", href: "/docs" },
  { id: "quickstart", label: "Quickstart", href: "/docs/quickstart" },
  { id: "framework-guides", label: "Framework Guides", href: "/docs/framework-guides" },
  { id: "how-tako-works", label: "How Tako Works", href: "/docs/how-tako-works" },
  { id: "cli", label: "CLI Reference", href: "/docs/cli" },
  { id: "tako-toml", label: "tako.toml Reference", href: "/docs/tako-toml" },
  { id: "development", label: "Development", href: "/docs/development" },
  { id: "deployment", label: "Deployment", href: "/docs/deployment" },
  { id: "troubleshooting", label: "Troubleshooting", href: "/docs/troubleshooting" },
];
---
<BaseLayout title={title} description="Tako documentation - a minimal deployment tool for self-hosted infrastructure.">
  <section class="sheet" data-docs-sheet data-heading-anchors={headingAnchors ? "true" : "false"}>
    <div class="sheet-top">
      <div class="breadcrumb">
        <a href="/">~</a> / <a href="/docs">docs</a> / <span>{heading}</span>
      </div>
      <button
        type="button"
        class="docs-menu-toggle"
        data-docs-menu-toggle
        aria-expanded="false"
        aria-controls="docs-nav-sidebar"
      >
        <span class="docs-menu-icon" aria-hidden="true"></span>
        <span>Menu</span>
      </button>
    </div>

    <div class="docs-shell">
      <aside class="docs-nav-sidebar" id="docs-nav-sidebar" data-docs-sidebar>
        <nav class="docs-nav-links" aria-label="Documentation navigation">
          {
            docsNav.map((item) => (
              <a href={item.href} class:list={["docs-nav-link", current === item.id && "is-active"]}>
                {item.label}
              </a>
            ))
          }
        </nav>
      </aside>

      <article class="docs-main">
        <div class="content">
          <slot />
        </div>
      </article>
    </div>
    <template data-docs-copy-template>
      <SnippetCopyButton class="docs-copy-button" ariaLabel="Copy code snippet" title="Copy" />
    </template>
  </section>

  <script is:inline>
    const docsSheet = document.querySelector("[data-docs-sheet]");
    const toggle = docsSheet?.querySelector("[data-docs-menu-toggle]");
    const sidebar = docsSheet?.querySelector("[data-docs-sidebar]");
    const contentRoot = docsSheet?.querySelector(".content");
    const copyButtonTemplate = docsSheet?.querySelector("[data-docs-copy-template]");
    const headingTargets = [];

    if (toggle instanceof HTMLButtonElement && sidebar instanceof HTMLElement) {
      const setOpen = (open) => {
        toggle.setAttribute("aria-expanded", open ? "true" : "false");
        sidebar.classList.toggle("is-open", open);
      };

      setOpen(false);

      toggle.addEventListener("click", () => {
        const currentlyOpen = toggle.getAttribute("aria-expanded") === "true";
        setOpen(!currentlyOpen);
      });

      sidebar.addEventListener("click", (event) => {
        if (!(event.target instanceof Element)) {
          return;
        }
        if (!event.target.closest("a")) {
          return;
        }
        if (window.matchMedia("(max-width: 900px)").matches) {
          setOpen(false);
        }
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 900) {
          setOpen(false);
        }
      });
    }

    if (contentRoot instanceof HTMLElement && docsSheet?.getAttribute("data-heading-anchors") === "true") {
      const headings = Array.from(
        contentRoot.querySelectorAll("h2[id], h3[id], h4[id], h5[id], h6[id]"),
      );

      for (const heading of headings) {
        if (!(heading instanceof HTMLElement)) {
          continue;
        }
        if (heading.querySelector(".docs-heading-anchor")) {
          continue;
        }

        const id = heading.getAttribute("id");
        if (!id) {
          continue;
        }

        const anchor = document.createElement("a");
        anchor.className = "docs-heading-anchor";
        anchor.href = `#${id}`;
        anchor.textContent = "#";

        const headingText = heading.textContent?.trim();
        anchor.setAttribute("aria-label", headingText ? `Link to section: ${headingText}` : `Link to section: ${id}`);
        anchor.title = "Link to this section";
        headingTargets.push({
          id,
          label: headingText || id,
          level: Number.parseInt(heading.tagName.slice(1), 10),
        });

        heading.append(anchor);

        heading.classList.add("docs-clickable-heading");
        heading.addEventListener("click", (event) => {
          if (!(event.target instanceof Element)) {
            return;
          }
          if (event.target.closest("a")) {
            return;
          }
          if (window.getSelection()?.toString()) {
            return;
          }
          window.location.hash = id;
        });
      }
    }

    if (sidebar instanceof HTMLElement && headingTargets.length > 0) {
      const activeNavLink = sidebar.querySelector(".docs-nav-link.is-active");
      if (activeNavLink instanceof HTMLAnchorElement) {
        const subLinks = document.createElement("div");
        subLinks.className = "docs-nav-sub-links";
        subLinks.setAttribute("aria-label", "On this page");

        const sectionHeadings = headingTargets.filter((item) => item.level <= 3);
        for (const item of sectionHeadings) {
          const subLink = document.createElement("a");
          subLink.className = "docs-nav-sub-link";
          if (item.level === 3) {
            subLink.classList.add("is-level-3");
          }
          subLink.href = `#${item.id}`;
          subLink.textContent = item.label;
          subLinks.append(subLink);
        }

        if (sectionHeadings.length > 0) {
          activeNavLink.insertAdjacentElement("afterend", subLinks);

          const updateActiveSubLink = () => {
            const activeHash = window.location.hash.replace(/^#/, "");
            const subLinkItems = Array.from(subLinks.querySelectorAll(".docs-nav-sub-link"));
            for (const subLink of subLinkItems) {
              const linkHash = subLink.getAttribute("href")?.replace(/^#/, "") ?? "";
              subLink.classList.toggle("is-active", activeHash !== "" && linkHash === activeHash);
            }
          };

          updateActiveSubLink();
          window.addEventListener("hashchange", updateActiveSubLink);
        }
      }
    }

    if (contentRoot instanceof HTMLElement) {
      const preBlocks = Array.from(contentRoot.querySelectorAll("pre"));

      for (const pre of preBlocks) {
        if (!(pre instanceof HTMLPreElement)) {
          continue;
        }
        if (pre.getAttribute("data-copy-ready") === "true") {
          continue;
        }

        const language = (pre.getAttribute("data-language") || "").toLowerCase();
        if (language === "text") {
          continue;
        }

        const code = pre.querySelector("code");
        if (!(code instanceof HTMLElement)) {
          continue;
        }

        const codeText = code.textContent?.replace(/\n$/, "") ?? "";
        if (!codeText.trim()) {
          continue;
        }

        const wrapper = document.createElement("div");
        wrapper.className = "docs-code-wrap";
        pre.parentNode?.insertBefore(wrapper, pre);
        wrapper.append(pre);

        pre.classList.add("docs-copyable-pre");
        pre.setAttribute("data-copy-ready", "true");

        let copyButton = null;
        if (copyButtonTemplate instanceof HTMLTemplateElement) {
          const node = copyButtonTemplate.content.firstElementChild?.cloneNode(true);
          if (node instanceof HTMLButtonElement) {
            copyButton = node;
          }
        }
        if (!(copyButton instanceof HTMLButtonElement)) {
          copyButton = document.createElement("button");
          copyButton.type = "button";
          copyButton.className = "docs-copy-button";
          copyButton.textContent = "Copy";
          copyButton.setAttribute("aria-label", "Copy code snippet");
          copyButton.setAttribute("title", "Copy");
        }

        copyButton.addEventListener("click", async (event) => {
          event.preventDefault();
          event.stopPropagation();

          const text = code.textContent?.replace(/\n$/, "") ?? "";
          if (!text) {
            return;
          }

          try {
            await navigator.clipboard.writeText(text);
            copyButton.classList.add("is-copied");
            window.setTimeout(() => {
              copyButton.classList.remove("is-copied");
            }, 1200);
          } catch {
            copyButton.classList.add("is-error");
            window.setTimeout(() => {
              copyButton.classList.remove("is-error");
            }, 1200);
          }
        });

        wrapper.append(copyButton);
      }
    }
  </script>
</BaseLayout>

<style is:global>
  .paint::before,
  .paint::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    filter: blur(18px);
    animation: floatBlob 10s ease-in-out infinite;
  }

  .paint::before {
    width: 340px;
    height: 340px;
    top: -120px;
    left: -130px;
    background: rgba(232, 135, 131, 0.32);
  }

  .paint::after {
    width: 420px;
    height: 420px;
    bottom: -170px;
    right: -160px;
    background: rgba(155, 196, 182, 0.3);
    animation-delay: -4s;
  }

  .site {
    z-index: 2;
  }

  .sheet {
    border: 2px solid var(--line);
    border-radius: var(--panel-radius);
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 18px 45px rgba(47, 42, 68, 0.1);
    padding: clamp(18px, 4vw, 36px);
  }

  .sheet-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  .breadcrumb {
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 0;
  }

  .breadcrumb a {
    color: var(--muted);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    color: var(--accent);
  }

  .breadcrumb span {
    color: var(--accent);
  }

  .docs-shell {
    display: grid;
    grid-template-columns: minmax(220px, 250px) minmax(0, 1fr);
    gap: clamp(16px, 2.5vw, 28px);
    align-items: start;
  }

  .docs-nav-sidebar {
    border: 2px solid var(--line);
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.9);
    padding: 12px;
    position: sticky;
    top: 92px;
  }

  .docs-nav-links {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .docs-nav-link {
    text-decoration: none;
    color: var(--muted);
    border: 1px solid transparent;
    border-radius: 10px;
    padding: 7px 10px;
    font-size: 15px;
    line-height: 1.3;
  }

  .docs-nav-link:hover {
    color: var(--ink);
    background: rgba(155, 196, 182, 0.18);
    border-color: rgba(155, 196, 182, 0.4);
  }

  .docs-nav-link.is-active {
    color: var(--ink);
    background: rgba(232, 135, 131, 0.2);
    border-color: rgba(232, 135, 131, 0.45);
    font-weight: 700;
  }

  .docs-nav-sub-links {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin: 2px 0 8px 12px;
    padding-left: 10px;
    border-left: 1px dashed rgba(47, 42, 68, 0.2);
  }

  .docs-nav-sub-link {
    text-decoration: none;
    color: var(--muted);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 4px 8px;
    font-size: 13px;
    line-height: 1.25;
  }

  .docs-nav-sub-link:hover {
    color: var(--ink);
    background: rgba(155, 196, 182, 0.14);
    border-color: rgba(155, 196, 182, 0.35);
  }

  .docs-nav-sub-link.is-level-3 {
    margin-left: 8px;
    font-size: 12px;
  }

  .docs-nav-sub-link.is-active {
    color: var(--ink);
    background: rgba(155, 196, 182, 0.2);
    border-color: rgba(155, 196, 182, 0.45);
    font-weight: 600;
  }

  .docs-main {
    min-width: 0;
  }

  .content {
    line-height: 1.55;
    font-size: clamp(16px, 1.5vw, 19px);
    color: var(--muted);
  }

  .content h1,
  .content h2,
  .content h3,
  .content h4 {
    font-family: var(--font-heading);
    color: var(--ink);
    margin-top: 28px;
    margin-bottom: 12px;
    line-height: 1.2;
  }

  .content h1 {
    font-size: clamp(28px, 4.2vw, 36px);
    border-bottom: 2px solid var(--line);
    padding-bottom: 8px;
  }

  .content h2 {
    font-size: clamp(24px, 3.6vw, 30px);
  }

  .content h3 {
    font-size: clamp(20px, 3vw, 24px);
  }

  .content :is(h2, h3, h4, h5, h6)[id] {
    scroll-margin-top: 108px;
    cursor: pointer;
  }

  .content .docs-clickable-heading {
    cursor: pointer;
  }

  .content .docs-clickable-heading:hover {
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 0.16em;
    text-decoration-color: rgba(232, 135, 131, 0.65);
  }

  .content .docs-heading-anchor {
    display: inline-block;
    margin-left: 8px;
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.75em;
    line-height: 1;
    color: var(--primary);
    border-bottom: none;
    text-decoration: none;
    opacity: 0;
    cursor: pointer;
    transition: opacity 0.14s ease;
  }

  .content :is(h2, h3, h4, h5, h6)[id]:hover .docs-heading-anchor {
    opacity: 1;
  }

  .content p,
  .content ul,
  .content ol,
  .content table,
  .content blockquote,
  .content pre {
    margin: 14px 0;
  }

  .content ul,
  .content ol {
    padding-left: 24px;
  }

  .content li {
    margin: 7px 0;
  }

  .content a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 2px solid transparent;
  }

  .content a:hover {
    border-bottom-color: var(--accent);
  }

  .content code {
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.85em;
    padding: 2px 6px;
    border-radius: 8px;
    background: rgba(232, 135, 131, 0.12);
    color: #3f3557;
  }

  .content pre {
    padding: 18px 20px;
    border: 2px solid var(--line);
    border-radius: 16px;
    background: var(--paper);
    overflow-x: auto;
    font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    line-height: 1.5;
    color: #2b2640;
  }

  .content .docs-code-wrap {
    position: relative;
    margin: 14px 0;
    --docs-pre-pad-top: 18px;
    --docs-first-line-height: 19.5px;
    --docs-copy-size: 32px;
  }

  .content .docs-code-wrap pre {
    margin: 0;
  }

  .content .docs-copyable-pre {
    padding-right: 84px;
  }

  .content .docs-copy-button {
    position: absolute;
    top: calc(var(--docs-pre-pad-top) + (var(--docs-first-line-height) - var(--docs-copy-size)) / 2);
    right: 12px;
    width: var(--docs-copy-size);
    height: var(--docs-copy-size);
    border: 1.5px solid rgba(47, 42, 68, 0.34);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.62);
    box-shadow: 0 2px 10px rgba(47, 42, 68, 0.1);
    color: rgba(47, 42, 68, 0.82);
    opacity: 0;
    pointer-events: none;
    transform: translateY(-2px) scale(0.97);
    transition: opacity 0.14s ease, transform 0.14s ease, border-color 0.14s ease, color 0.14s ease, background-color 0.14s ease;
    cursor: pointer;
  }

  .content .docs-copy-button .snippet-copy-icon {
    width: 15px;
    height: 15px;
  }

  .content .docs-code-wrap:hover .docs-copy-button,
  .content .docs-code-wrap:focus-within .docs-copy-button,
  .content .docs-copy-button:focus-visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0) scale(1);
  }

  .content .docs-copy-button:hover {
    border-color: rgba(232, 135, 131, 0.68);
    color: var(--accent);
    background: rgba(255, 255, 255, 0.95);
  }

  .content .docs-copy-button.is-copied {
    background: rgba(155, 196, 182, 0.42);
    border-color: rgba(101, 168, 145, 0.78);
    color: rgba(19, 95, 69, 0.98);
  }

  .content .docs-copy-button.is-error {
    background: rgba(232, 135, 131, 0.18);
    border-color: rgba(232, 135, 131, 0.75);
    color: #8d2727;
  }

  .content pre code {
    padding: 0;
    background: none;
  }

  .content blockquote {
    border-left: 4px solid var(--secondary);
    background: var(--mint-soft);
    border-radius: 0 12px 12px 0;
    padding: 12px 14px;
    color: #2c2b3d;
  }

  .content table {
    width: 100%;
    border-collapse: collapse;
    font-size: 15px;
    border: 2px solid var(--line);
  }

  .content th,
  .content td {
    border: 1px solid var(--line);
    padding: 8px 10px;
  }

  .content th {
    font-family: "Nunito", sans-serif;
    color: #2f2a44;
    background: rgba(155, 196, 182, 0.18);
  }

  .content hr {
    border: none;
    border-top: 2px solid var(--line);
    margin: 26px 0;
  }

  .content strong {
    color: #2f2a44;
  }

  .content .dynamic-phrase {
    display: inline-block;
    font-weight: 700;
    color: inherit;
    background: var(--secondary);
    padding: 0.08em 0.35em;
    line-height: 1;
  }

  .docs-menu-icon,
  .docs-menu-icon::before,
  .docs-menu-icon::after {
    content: "";
    display: block;
    width: 16px;
    height: 2px;
    border-radius: 2px;
    background: var(--ink);
    transition: transform 0.16s ease;
  }

  .docs-menu-icon {
    position: relative;
  }

  .docs-menu-icon::before {
    position: absolute;
    top: -5px;
    left: 0;
  }

  .docs-menu-icon::after {
    position: absolute;
    top: 5px;
    left: 0;
  }

  .docs-menu-toggle[aria-expanded="true"] .docs-menu-icon {
    background: transparent;
  }

  .docs-menu-toggle[aria-expanded="true"] .docs-menu-icon::before {
    transform: translateY(5px) rotate(45deg);
  }

  .docs-menu-toggle[aria-expanded="true"] .docs-menu-icon::after {
    transform: translateY(-5px) rotate(-45deg);
  }

  @keyframes floatBlob {
    0%,
    100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .docs-menu-toggle {
    display: none;
    align-items: center;
    gap: 8px;
    font: inherit;
    font-size: 15px;
    font-weight: 700;
    border: 2px solid var(--line);
    border-radius: 999px;
    padding: 7px 12px;
    background: rgba(255, 255, 255, 0.92);
    color: var(--ink);
    cursor: pointer;
  }

  @media (max-width: 900px) {
    .sheet-top {
      margin-bottom: 14px;
    }

    .docs-menu-toggle {
      display: inline-flex;
    }

    .docs-shell {
      display: block;
    }

    .docs-nav-sidebar {
      position: static;
      display: none;
      margin-bottom: 14px;
    }

    .docs-nav-sidebar.is-open {
      display: block;
    }
  }

  @media (max-width: 640px) {
    .content .docs-code-wrap {
      --docs-pre-pad-top: 14px;
    }

    .content pre {
      padding: 14px 16px;
    }
  }
</style>
