---
layout: ../../layouts/DocsLayout.astro
title: Tako Docs - tako.toml Reference
heading: tako.toml Reference
current: tako-toml
---

# `tako.toml` Reference

`tako.toml` is your project's control panel for app metadata, build/deploy behavior, env vars, routes, and server behavior.

## Minimal Config

This is the minimal starting point generated by `tako init`:

```toml
name = "my-app"
runtime = "bun"
# preset = "tanstack-start" # Optional runtime-local preset; omit for base runtime preset

[envs.production]
route = "my-app.example.com"
```

`tako init` prompts for `name` and `[envs.production].route`, then prompts for runtime (top-level `runtime`, with `--runtime` flag). In interactive mode it fetches runtime-family presets (shows `Fetching presets...`) and offers base runtime preset + fetched family presets + a custom option; if no family presets are available, it skips preset selection and uses the runtime base preset. Top-level `preset` is written only when a non-base preset is selected (for base runtime preset or custom mode, it remains unset/commented). It only writes `main` when adapter inference finds an entrypoint that differs from the selected preset default.

`name` is optional. If omitted, Tako uses a sanitized project directory name.
Setting `name` is recommended for stable identity: keep it unique per server. Renaming it later creates a new app identity/path, so remove the old deployment manually when needed.

## Top-Level App Fields

App-level metadata.

```toml
name = "my-app"
main = "server/index.mjs"
runtime = "bun"
# preset = "tanstack-start"

[build]
# include = ["dist/**", ".output/**"]
# exclude = ["**/*.map"]
# assets = ["dist/client", "assets/shared"]
# [[build.stages]]
# name = "frontend-assets"
# working_dir = "frontend"
# install = "bun install"
# run = "bun run build"
```

- `name`: optional stable app identifier used in deploy paths and local dev hostnames.
  - If omitted, Tako falls back to the sanitized project directory name.
  - Keep it unique per server. Renaming it creates a new app identity/path; delete old deployment manually if needed.
- `main`: optional runtime entry override written to deployed `app.json` and used by `tako dev`/`tako deploy`.
  - If omitted, Tako uses preset top-level `main` when present.
  - If neither `tako.toml main` nor preset `main` is set, deploy/dev fail.
  - During deploy artifact prep, Tako verifies this resolved path exists in the post-build app directory and fails if it is missing.
- `runtime`: optional adapter override (`bun`, `node`, `deno`) used when selecting the default base preset.
- `preset`: optional runtime-local build preset override. If omitted, deploy/dev use adapter base preset from top-level `runtime` when set, otherwise detected adapter (`unknown` falls back to `bun`). Supports:
  - runtime-local aliases: `tanstack-start` (resolved under selected `runtime`)
  - pinned runtime-local aliases: `tanstack-start@<commit-hash>`
  - Namespaced aliases in `tako.toml` (for example `js/tanstack-start`) are rejected.
  - `github:` preset refs are not supported.
  - Full schema/examples: [`Presets`](/docs/presets)
- `[build]`: deploy artifact build config.
  - `include`: optional artifact include globs (`**/*` is used when unset).
  - `exclude`: optional artifact exclude globs (appended to preset excludes).
  - `assets`: optional project-relative directories merged into app `public/` after build (later entries overwrite earlier files on conflicts).
  - `stages`: optional app-level custom build stages (`[[build.stages]]`) that run after preset build commands.
  - `[[build.stages]]` fields:
    - `name` (optional display label in deploy output)
    - `working_dir` (optional app-relative directory for stage commands; absolute paths and `..` are rejected)
    - `install` (optional command run before `run`)
    - `run` (required command)
  - Stage execution order per target is fixed: preset stage first (`[build].install`, `[build].build`), then `[[build.stages]]` in declaration order.
  - Adapter base presets (`bun`, `node`, `deno`) are built into the CLI (not loaded from workspace preset files).
  - Runtime family preset definitions live in `presets/<family>.toml` (for example `presets/js.toml`), where each preset is a section (`[tanstack-start]`, etc.).
  - Runtime base presets (`bun`, `node`, `deno`) define lifecycle defaults (`dev`, `install`, `start`, `[build].install`, `[build].build`).
  - Runtime base presets also provide default build filters/targets (`[build].exclude`, `[build].targets`, `[build].container`) and default `assets`.
  - Preset `[build].exclude` appends to runtime-base excludes (base-first, deduplicated).
  - Preset `[build].targets` and `[build].container` override runtime defaults when set (including explicit empty arrays or explicit `container` values).
  - Preset `[build].assets` override runtime-base `assets` when set.
  - Build preset files support optional top-level `name`, top-level `main`, and preset `[build]` keys (`assets`, `exclude`, optional `targets = ["linux-<arch>-<libc>", ...]`, optional `container`). Presets can still override runtime lifecycle fields when needed. Preset top-level `assets`, preset `[[build.stages]]`, legacy preset `[dev]`, `[deploy]`, preset `include`, `[artifact]`, top-level `dev_cmd`, and `[build].docker` are not supported.
  - Bun `tanstack-start` defaults `main = "dist/server/tako-entry.mjs"` and `[build].assets = ["dist/client"]`.
  - Deploy writes lock metadata to `.tako/build.lock.json` so the resolved preset commit stays reproducible across deploys.
  - Deploy build mode is controlled by preset `[build].container`.
    - `true`: Docker target builds
    - `false`: local host target builds
    - unset: defaults to Docker only when `[build].targets` is non-empty
  - Docker builds reuse target-scoped dependency cache volumes (mise + runtime cache mounts) while keeping build containers ephemeral.
  - Runtime version is resolved via `mise exec -- <tool> --version` when local `mise` is available, then falls back to `mise.toml`, then `latest`.
  - Deploy artifact cache keys include resolved preset source/commit, runtime tool/version, build mode (Docker/local), and `build.include` / `build.exclude` / `build.assets` / `build.stages`; changing these inputs invalidates cache and triggers rebuild for affected targets.
  - Bun runtime dependencies are installed on server from the uploaded release (`bun install --production`).
  - On every deploy, Tako prunes local `.tako/artifacts/` cache (best-effort): keeps 30 newest source archives, keeps 90 newest target artifacts, and removes orphan target metadata files.
- Legacy top-level `build = "..."` and top-level `assets = [...]` are not supported.

## `[vars]`

Global environment variables applied to every environment.

```toml
[vars]
LOG_LEVEL = "info"
API_BASE_URL = "https://api.example.com"
```

## `[vars.<environment>]`

Per-environment overrides merged on top of `[vars]`.

```toml
[vars.production]
LOG_LEVEL = "warn"

[vars.staging]
LOG_LEVEL = "debug"
API_BASE_URL = "https://staging-api.example.com"
```

## `[envs.<environment>]`

Environment route declarations.

```toml
[envs.production]
route = "api.example.com"
# routes = ["api.example.com", "www.api.example.com"]
# route = "example.com/api/*"
# routes = ["example.com/api/*", "example.com/admin/*"]
```

- `route`: single hostname/path pattern.
- `routes`: multiple route patterns (use this instead of `route` when you have more than one).
- Each environment can set `route` or `routes`, but not both.
- Environment sections accept only `route`/`routes`. Put env vars in `[vars]` / `[vars.<environment>]`.
- Every non-development environment must define `route` or `routes`.
- `[envs.development]` may omit routes and defaults to `{app}.tako.local` for `tako dev`.
- Development routes must be `{app}.tako.local` or a subdomain of it.
- Empty route sets are rejected for non-development environments. There is no implicit catch-all routing mode.
- Routes must include a hostname (path-only routes are invalid).
- `example.com` and `example.com/*` are equivalent and both match all paths on `example.com`.
- Public route hostnames use ACME certificates; private/local hostnames (`localhost`, `*.localhost`, single-label hosts, and reserved suffixes like `*.local`) use self-signed certs generated during deploy.
- Path route examples:
  - `example.com/api/*` matches `/api`, `/api/`, and `/api/...`
  - `example.com/admin/*` matches `/admin`, `/admin/`, and `/admin/...`

## `[servers]`

Default runtime settings applied to every mapped server unless overridden.

```toml
[servers]
instances = 0
port = 80
idle_timeout = 300
```

- `instances = 0` means on-demand instances. Deploy keeps one warm instance running; idle timeout can scale it to zero. Once at zero, first request waits for cold start readiness up to startup timeout (30s default), then returns `504 App startup timed out` if still not ready. If startup fails before readiness, it returns `502 App failed to start`.
- `port` is the app upstream port.
- `idle_timeout` is in seconds.

## `[servers.<name>]`

Per-server overrides. The section name must match a server added with `tako servers add`.

```toml
[servers.production]
env = "production"
instances = 2
port = 8080
idle_timeout = 300
```

- `env` is required.
- `instances`, `port`, and `idle_timeout` are optional overrides.
- `arch`/`libc` are not configured in `tako.toml`; Tako detects and stores them in global server config (`~/.tako/config.toml`) when adding servers.

## Variable Merge Order

For a target environment, variables are merged in this order:

1. `[vars]`
2. `[vars.<environment>]`
3. Auto-set by Tako during deploy (`TAKO_ENV=<environment>`, `TAKO_BUILD=<version>`, plus runtime vars like `NODE_ENV` / `BUN_ENV`)

Later values override earlier ones when keys match.

## Complete Example

```toml
name = "my-app"
main = "server/index.mjs"
runtime = "bun"

[build]
assets = ["assets/shared"]

[vars]
LOG_LEVEL = "info"

[vars.production]
LOG_LEVEL = "warn"
LOG_FORMAT = "json"

[vars.staging]
LOG_LEVEL = "debug"

[envs.production]
routes = ["api.example.com", "www.api.example.com"]

[envs.staging]
route = "staging.example.com"

[servers]
instances = 0
port = 80
idle_timeout = 300

[servers.primary]
env = "production"
instances = 2
```
